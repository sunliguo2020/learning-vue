"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/system.js"),l=require("../../api/apis.js");if(require("../../utils/request.js"),!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"preview",setup(a){const s=e.ref(!0),u=e.ref(null),n=e.ref(null),t=e.ref(0),i=e.ref([]),c=e.ref(null),r=e.ref(0),v=e.ref(null),d=e.ref([]),p=e.ref(!1),m=e.index.getStorageSync("storageClissList");i.value=m.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")}))),console.log("storageClissList",m),e.onLoad((e=>{c.value=e.id,r.value=i.value.findIndex((e=>e._id===c.value)),v.value=i.value[r.value],f()}));const g=e=>{r.value=e.detail.current,v.value=i.value[r.value],console.log("当前图片信息：",v.value),f()};function f(){d.value.push(r.value<=0?i.value.length-1:r.value-1,r.value,r.value>=i.value.length-1?0:r.value+1),d.value=[...new Set(d.value)]}const h=()=>{u.value.close()},w=()=>{u.value.open()},x=()=>{console.log("评分弹窗",v.value),v.value.userScore&&(p.value=!0,t.value=v.value.userScore,console.log(t.value)),n.value.open("center"),u.value.close()},y=e=>{n.value.close(),t.value=0,p.value=!1},_=async()=>{console.log(t.value);let{classid:o,_id:a}=v.value;0===(await l.apiGetSetupScore({classid:o,wallId:a,userScore:t.value})).errCode&&(e.index.showToast({title:"评分成功",icon:"none"}),i.value[r.value].userScore=t.value,e.index.setStorageSync("storageClissList",i.value),y())},S=()=>{console.log(s),s.value=!s.value},b=function(e){console.log("rate发生改变:"+JSON.stringify(e)),t.value=e.value},j=()=>{e.index.navigateBack()},C=async function(){console.log("下载");try{e.index.showLoading({title:"下载中",mask:!0});let{classid:o,_id:a}=v.value;const s=await l.apiWriteDownload({classid:o,wallId:a});if(console.log("保存下载记录的接口",s),0!=s.errCode)throw s;e.index.getImageInfo({src:v.value.picurl,success:o=>{console.log(o.path),e.index.saveImageToPhotosAlbum({filePath:o.path,success:o=>{console.log(o),e.index.showToast({title:"保存壁纸成功",icon:"none"})},fail:o=>{console.log(o),"saveImageToPhotosAlbum:fail cancel"==o.errMsg?e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"}):e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:o=>{o.confirm&&(console.log("确认授权了"),e.index.openSetting({success:o=>{console.log(o),o.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取授权失败",icon:"none"})}}))}})}})},complete:()=>{e.index.hideLoading()}})}catch(o){console.log(o),e.index.hideLoading()}};return(l,a)=>e.e({a:e.f(i.value,((o,l,a)=>e.e({a:d.value.includes(l)},d.value.includes(l)?{b:e.o(S,o._id),c:o.picurl}:{},{d:o._id}))),b:e.o(g),c:r.value,d:s.value},s.value?e.e({e:e.p({type:"back",color:"#fff",size:"20"}),f:e.unref(o.getStatusBarHeight)()+"px",g:e.o(j),h:e.t(r.value+1),i:e.t(i.value.length),j:e.p({date:new Date,format:"hh:mm"}),k:e.p({date:new Date,format:"MM月dd日"}),l:v.value},v.value?{m:e.p({type:"info",size:"28"}),n:e.o(w),o:e.p({type:"star",size:"28"}),p:e.t(v.value.score),q:e.o(x),r:e.p({type:"download",size:"23"}),s:e.o(C)}:{}):{},{t:e.p({type:"closeempty",size:"18",color:"#999"}),v:e.o(h),w:v.value},v.value?{x:e.t(v.value._id),y:e.t(v.value.nickname),z:e.o(b),A:e.p({value:v.value.score}),B:e.t(v.value.score),C:e.t(v.value.description),D:e.f(v.value.tabs,((o,l,a)=>({a:e.t(o),b:l})))}:{},{E:e.sr(u,"9d01ad79-6",{k:"infoPopup"}),F:e.p({type:"bottom"}),G:e.t(p.value?"已经评过分了":"壁纸评分"),H:e.p({type:"closeempty",size:"18",color:"#999"}),I:e.o(y),J:e.o((()=>{})),K:e.o((e=>t.value=e)),L:e.p({"allow-half":!0,disabled:p.value,modelValue:t.value}),M:e.t(t.value),N:e.o(_),O:!t.value||p.value,P:e.sr(n,"9d01ad79-9",{k:"scorePopup"}),Q:e.p({"is-mask-click":!1})})}},s=e._export_sfc(a,[["__scopeId","data-v-9d01ad79"]]);wx.createPage(s);
